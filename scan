#!/bin/bash
# scan - Quick scan from ScanSnap ix500
#
# Two modes:
#   Paperless mode: If PAPERLESS_URL and PAPERLESS_TOKEN are set,
#                   uploads PDF to Paperless-ngx (which handles OCR).
#   Local mode:     Otherwise, runs OCR locally and saves to
#                   ~/Documents/scanner-inbox/
#
# Features:
# - A4 page size
# - Duplex (both sides)
# - Color scan with auto-grayscale conversion
# - Auto-skip blank pages (back sides)
# - Multi-page batch to single PDF

set -e

# Auto-detect scanner device
DEVICE=$(scanimage -L 2>/dev/null | grep -oP "fujitsu:ScanSnap iX500:\d+" | head -1)
if [ -z "$DEVICE" ]; then
    echo "Error: ScanSnap iX500 not found. Is it connected and powered on?"
    exit 1
fi

# Determine mode
if [ -n "$PAPERLESS_URL" ] && [ -n "$PAPERLESS_TOKEN" ]; then
    MODE=paperless
else
    MODE=local
fi

TIMESTAMP=$(date '+%Y-%m-%d-%H%M%S')
TMPDIR=$(mktemp -d)
FILENAME="${1:-scan-$TIMESTAMP}"

cleanup() {
    rm -rf "$TMPDIR"
}
trap cleanup EXIT

echo "Scanning (duplex, color, A4)..."
scanimage --device "$DEVICE" \
    --format=tiff \
    --resolution 300 \
    --mode Color \
    --source "ADF Duplex" \
    --page-width 210 \
    --page-height 297 \
    --swskip 20 \
    --swcrop=yes \
    --swdespeck 2 \
    --overscan On \
    --prepick On \
    --buffermode On \
    --batch="$TMPDIR/page-%04d.tiff" \
    --batch-count=-1 \
    2>&1 | grep -v "^$" || true

# Count scanned pages
PAGECOUNT=$(ls -1 "$TMPDIR"/page-*.tiff 2>/dev/null | wc -l)

if [ "$PAGECOUNT" -eq 0 ]; then
    echo "No pages scanned (feeder empty?)"
    exit 1
fi

echo "Scanned $PAGECOUNT page(s), detecting color..."

# Auto-detect color vs grayscale for each page
# Convert to grayscale if saturation is low (no significant color)
COLOR_PAGES=0
GRAY_PAGES=0
for tiff in "$TMPDIR"/page-*.tiff; do
    # Check color saturation - if mean saturation < 10%, convert to grayscale
    saturation=$(magick "$tiff" -colorspace HSL -channel G -separate +channel -format "%[fx:mean*100]" info: 2>/dev/null || echo "0")
    if (( $(echo "$saturation < 10" | bc -l) )); then
        magick "$tiff" -colorspace Gray "$tiff"
        GRAY_PAGES=$((GRAY_PAGES + 1))
    else
        COLOR_PAGES=$((COLOR_PAGES + 1))
    fi
done

if [ "$GRAY_PAGES" -gt 0 ] && [ "$COLOR_PAGES" -gt 0 ]; then
    echo "Mixed: $COLOR_PAGES color, $GRAY_PAGES grayscale"
elif [ "$GRAY_PAGES" -gt 0 ]; then
    echo "Converted to grayscale"
else
    echo "Color detected"
fi

if [ "$MODE" = "paperless" ]; then
    echo "Creating PDF..."
    magick "$TMPDIR"/page-*.tiff "$TMPDIR/$FILENAME.pdf"

    echo "Uploading to Paperless..."
    RESPONSE=$(curl -sk -w "\n%{http_code}" \
        -H "Authorization: Token $PAPERLESS_TOKEN" \
        -F "document=@$TMPDIR/$FILENAME.pdf" \
        -F "created=$(date '+%Y-%m-%d')" \
        "$PAPERLESS_URL/api/documents/post_document/")

    HTTP_CODE=$(echo "$RESPONSE" | tail -1)
    if [ "$HTTP_CODE" -eq 200 ]; then
        FILESIZE=$(ls -lh "$TMPDIR/$FILENAME.pdf" | awk '{print $5}')
        echo "Done: $FILENAME.pdf ($PAGECOUNT pages, $FILESIZE) uploaded to Paperless"
    else
        echo "Upload failed (HTTP $HTTP_CODE)"
        BODY=$(echo "$RESPONSE" | sed '$d')
        [ -n "$BODY" ] && echo "$BODY"
        exit 1
    fi
else
    OUTDIR="$HOME/Documents/scanner-inbox"
    OUTFILE="$OUTDIR/$FILENAME.pdf"
    mkdir -p "$OUTDIR"

    echo "Running OCR..."
    magick "$TMPDIR"/page-*.tiff "$TMPDIR/combined.tiff"
    ocrmypdf "$TMPDIR/combined.tiff" "$OUTFILE" \
        -l nld+eng \
        --rotate-pages \
        --rotate-pages-threshold 2 \
        --deskew \
        --clean \
        -O 3 \
        --jpeg-quality 60 \
        --jbig2-lossy

    FILESIZE=$(ls -lh "$OUTFILE" | awk '{print $5}')
    echo "Done: $OUTFILE ($PAGECOUNT pages, $FILESIZE)"
fi
