#!/bin/bash
# scan - Quick scan from ScanSnap ix500
#
# Three modes (determined by environment variables):
#   Paperless API mode:    PAPERLESS_URL and PAPERLESS_TOKEN set
#                          → uploads PDF to Paperless-ngx via API
#   Paperless folder mode: PAPERLESS_CONSUME_DIR set
#                          → writes PDF directly to consume folder
#   Local mode:            none of the above set
#                          → runs OCR locally, saves to ~/Documents/scanner-inbox/
#
# Features:
# - A4 page size with bleed margin for edge-to-edge capture
# - Duplex (both sides)
# - Color scan with optional auto-grayscale conversion (COLOR_DETECT)
# - Auto-skip blank pages (back sides)
# - Multi-page batch to single PDF

set -e

# Scanner device — from env or auto-detect
if [ -n "$SCANNER_DEVICE" ]; then
    DEVICE="$SCANNER_DEVICE"
else
    DEVICE=$(scanimage -L 2>/dev/null | grep -oP "fujitsu:ScanSnap iX500:\d+" | head -1)
fi
if [ -z "$DEVICE" ]; then
    echo "Error: ScanSnap iX500 not found. Is it connected and powered on?"
    exit 1
fi

# Determine mode
if [ -n "$PAPERLESS_URL" ] && [ -n "$PAPERLESS_TOKEN" ]; then
    MODE=paperless-api
elif [ -n "$PAPERLESS_CONSUME_DIR" ]; then
    MODE=paperless-folder
else
    MODE=local
fi

# Bleed margin for edge-to-edge capture (avoids cut-off edges)
BLEED_MM=10
PAGE_WIDTH_MM=$((210 + BLEED_MM))
PAGE_HEIGHT_MM=$((297 + BLEED_MM))

TIMESTAMP=$(date '+%Y-%m-%d-%H%M%S')
WORKDIR=$(mktemp -d)
FILENAME="${1:-scan-$TIMESTAMP}"

cleanup() {
    rm -rf "$WORKDIR"
}
trap cleanup EXIT

echo "Scanning (duplex, color, A4)..."
scanimage --device "$DEVICE" \
    --format=tiff \
    --resolution 300 \
    --mode Color \
    --source "ADF Duplex" \
    --page-width "$PAGE_WIDTH_MM" \
    --page-height "$PAGE_HEIGHT_MM" \
    --swskip 20 \
    --swcrop=yes \
    --swdespeck 2 \
    --overscan On \
    --prepick On \
    --buffermode On \
    --batch="$WORKDIR/page-%04d.tiff" \
    --batch-count=-1 \
    2>&1 | grep -v "^$" || true

# Count scanned pages
PAGECOUNT=$(ls -1 "$WORKDIR"/page-*.tiff 2>/dev/null | wc -l)

if [ "$PAGECOUNT" -eq 0 ]; then
    echo "No pages scanned (feeder empty?)"
    exit 1
fi

echo "Scanned $PAGECOUNT page(s)"

# Auto-detect color vs grayscale for each page (reduces file size)
# Can be disabled with COLOR_DETECT=false
if [ "${COLOR_DETECT:-true}" = "true" ]; then
    echo "Detecting color..."
    COLOR_PAGES=0
    GRAY_PAGES=0
    for tiff in "$WORKDIR"/page-*.tiff; do
        # Check color saturation - if mean saturation < 10%, convert to grayscale
        saturation=$(magick "$tiff" -colorspace HSL -channel G -separate +channel -format "%[fx:mean*100]" info: 2>/dev/null || echo "0")
        if (( $(echo "$saturation < 10" | bc -l) )); then
            magick "$tiff" -colorspace Gray "$tiff"
            GRAY_PAGES=$((GRAY_PAGES + 1))
        else
            COLOR_PAGES=$((COLOR_PAGES + 1))
        fi
    done

    if [ "$GRAY_PAGES" -gt 0 ] && [ "$COLOR_PAGES" -gt 0 ]; then
        echo "Mixed: $COLOR_PAGES color, $GRAY_PAGES grayscale"
    elif [ "$GRAY_PAGES" -gt 0 ]; then
        echo "Converted to grayscale"
    else
        echo "Color detected"
    fi
else
    echo "Color detection disabled, converting to grayscale..."
    for tiff in "$WORKDIR"/page-*.tiff; do
        magick "$tiff" -colorspace Gray "$tiff"
    done
fi

if [ "$MODE" = "paperless-api" ]; then
    echo "Creating PDF..."
    magick "$WORKDIR"/page-*.tiff "$WORKDIR/$FILENAME.pdf"

    echo "Uploading to Paperless..."
    RESPONSE=$(curl -sk -w "\n%{http_code}" \
        -H "Authorization: Token $PAPERLESS_TOKEN" \
        -F "document=@$WORKDIR/$FILENAME.pdf" \
        -F "created=$(date '+%Y-%m-%d')" \
        "$PAPERLESS_URL/api/documents/post_document/")

    HTTP_CODE=$(echo "$RESPONSE" | tail -1)
    if [ "$HTTP_CODE" -eq 200 ]; then
        FILESIZE=$(ls -lh "$WORKDIR/$FILENAME.pdf" | awk '{print $5}')
        echo "Done: $FILENAME.pdf ($PAGECOUNT pages, $FILESIZE) uploaded to Paperless"
    else
        echo "Upload failed (HTTP $HTTP_CODE)"
        BODY=$(echo "$RESPONSE" | sed '$d')
        [ -n "$BODY" ] && echo "$BODY"
        exit 1
    fi

elif [ "$MODE" = "paperless-folder" ]; then
    OUTFILE="$PAPERLESS_CONSUME_DIR/$FILENAME.pdf"

    echo "Creating PDF..."
    magick "$WORKDIR"/page-*.tiff "$OUTFILE"

    FILESIZE=$(ls -lh "$OUTFILE" | awk '{print $5}')
    echo "Done: $OUTFILE ($PAGECOUNT pages, $FILESIZE)"

else
    OUTDIR="$HOME/Documents/scanner-inbox"
    OUTFILE="$OUTDIR/$FILENAME.pdf"
    mkdir -p "$OUTDIR"

    echo "Running OCR..."
    magick "$WORKDIR"/page-*.tiff "$WORKDIR/combined.tiff"
    ocrmypdf "$WORKDIR/combined.tiff" "$OUTFILE" \
        -l nld+eng \
        --rotate-pages \
        --rotate-pages-threshold 2 \
        --deskew \
        --clean \
        -O 3 \
        --jpeg-quality 60 \
        --jbig2-lossy

    FILESIZE=$(ls -lh "$OUTFILE" | awk '{print $5}')
    echo "Done: $OUTFILE ($PAGECOUNT pages, $FILESIZE)"
fi
