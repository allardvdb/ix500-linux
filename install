#!/bin/bash
# install - Interactive installer for ix500-linux scanning workflow
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ok()   { echo -e "  ${GREEN}✓${NC} $1"; }
warn() { echo -e "  ${YELLOW}!${NC} $1"; }
fail() { echo -e "  ${RED}✗${NC} $1"; }

MISSING_BREW=()
MISSING_SYSTEM=()

check_cmd() {
    local cmd=$1 brew_pkg=$2 system_pkg=$3
    if command -v "$cmd" &>/dev/null; then
        ok "$cmd found: $(command -v "$cmd")"
        return 0
    else
        fail "$cmd not found"
        [ -n "$brew_pkg" ] && MISSING_BREW+=("$brew_pkg")
        [ -n "$system_pkg" ] && MISSING_SYSTEM+=("$system_pkg")
        return 1
    fi
}

echo "ix500-linux installer"
echo "====================="
echo

# --- Mode selection ---
echo "Select scanning mode:"
echo "  1) Paperless-ngx  - Upload scans directly to Paperless (recommended)"
echo "  2) Local           - OCR locally, save to ~/Documents/scanner-inbox/"
echo
read -rp "Choice [1/2]: " MODE_CHOICE
echo

if [ "$MODE_CHOICE" = "2" ]; then
    MODE=local
else
    MODE=paperless
fi

# --- Dependency check ---
echo "Checking dependencies..."
DEPS_OK=true

check_cmd scanimage "" "sane-backends" || DEPS_OK=false
check_cmd magick "imagemagick" "" || DEPS_OK=false
check_cmd bc "" "bc" || DEPS_OK=false

if [ "$MODE" = "local" ]; then
    check_cmd ocrmypdf "ocrmypdf" "" || DEPS_OK=false
    check_cmd tesseract "tesseract" "" || DEPS_OK=false
    if command -v tesseract &>/dev/null; then
        if tesseract --list-langs 2>/dev/null | grep -q "^nld$"; then
            ok "tesseract language: nld"
        else
            fail "tesseract language: nld missing"
            MISSING_BREW+=("tesseract-lang")
            DEPS_OK=false
        fi
    fi
fi

if [ "$MODE" = "paperless" ]; then
    check_cmd curl "" "curl" || DEPS_OK=false
fi

# Notification dependencies
check_cmd notify-send "libnotify" "libnotify" || DEPS_OK=false
check_cmd xdg-open "" "xdg-utils" || DEPS_OK=false
check_cmd xdg-terminal-exec "" "xdg-terminal-exec" || DEPS_OK=false

echo

if [ "$DEPS_OK" = false ]; then
    echo "Missing dependencies. Install them with:"
    [ ${#MISSING_SYSTEM[@]} -gt 0 ] && echo "  sudo dnf install ${MISSING_SYSTEM[*]}"
    [ ${#MISSING_BREW[@]} -gt 0 ] && echo "  brew install ${MISSING_BREW[*]}"
    echo
    read -rp "Continue anyway? [y/N]: " CONTINUE
    [ "$CONTINUE" != "y" ] && exit 1
    echo
fi

# --- Paperless configuration ---
if [ "$MODE" = "paperless" ]; then
    echo "Paperless-ngx configuration:"

    EXISTING_URL=""
    EXISTING_TOKEN=""
    ENV_FILE="$HOME/.config/environment.d/paperless.conf"
    if [ -f "$ENV_FILE" ]; then
        EXISTING_URL=$(grep -oP '(?<=^PAPERLESS_URL=).+' "$ENV_FILE" 2>/dev/null || true)
        EXISTING_TOKEN=$(grep -oP '(?<=^PAPERLESS_TOKEN=).+' "$ENV_FILE" 2>/dev/null || true)
    fi

    if [ -n "$EXISTING_URL" ]; then
        read -rp "  URL [$EXISTING_URL]: " PAPERLESS_URL
        PAPERLESS_URL="${PAPERLESS_URL:-$EXISTING_URL}"
    else
        read -rp "  URL (e.g. https://paperless.example.com): " PAPERLESS_URL
    fi

    if [ -n "$EXISTING_TOKEN" ]; then
        read -rp "  API token [****${EXISTING_TOKEN: -4}]: " PAPERLESS_TOKEN
        PAPERLESS_TOKEN="${PAPERLESS_TOKEN:-$EXISTING_TOKEN}"
    else
        read -rp "  API token: " PAPERLESS_TOKEN
    fi

    if [ -z "$PAPERLESS_URL" ] || [ -z "$PAPERLESS_TOKEN" ]; then
        echo "Error: URL and token are required for Paperless mode"
        exit 1
    fi

    # Test connection
    echo -n "  Testing connection... "
    HTTP_CODE=$(curl -sk -o /dev/null -w "%{http_code}" --connect-timeout 5 \
        -H "Authorization: Token $PAPERLESS_TOKEN" \
        "$PAPERLESS_URL/api/" 2>/dev/null || echo "000")
    if [ "$HTTP_CODE" = "200" ]; then
        ok "connected"
    else
        warn "could not verify (HTTP $HTTP_CODE) - continuing anyway"
    fi

    # Write environment file
    mkdir -p "$HOME/.config/environment.d"
    cat > "$ENV_FILE" <<EOF
PAPERLESS_URL=$PAPERLESS_URL
PAPERLESS_TOKEN=$PAPERLESS_TOKEN
EOF
    ok "Saved credentials to $ENV_FILE"
    echo
fi

# --- Install files ---
echo "Installing..."

mkdir -p "$HOME/.local/bin"
cp scan scan-button-poll "$HOME/.local/bin/"
chmod +x "$HOME/.local/bin/scan" "$HOME/.local/bin/scan-button-poll"
ok "Scripts installed to ~/.local/bin/"

mkdir -p "$HOME/.config/systemd/user"
cp scan-button.service "$HOME/.config/systemd/user/"
ok "Systemd service installed"

echo
echo "Installing udev rules (requires sudo)..."
sudo cp 99-scansnap-ix500.rules /etc/udev/rules.d/
ok "Udev rules installed"

# --- Activate ---
echo
echo "Activating..."

if [ "$MODE" = "paperless" ]; then
    # Load env vars into current systemd session
    systemctl --user set-environment \
        PAPERLESS_URL="$PAPERLESS_URL" \
        PAPERLESS_TOKEN="$PAPERLESS_TOKEN"
fi

systemctl --user daemon-reload
sudo udevadm control --reload-rules
sudo udevadm trigger
ok "Systemd and udev reloaded"

systemctl --user restart scan-button.service 2>/dev/null && \
    ok "Service started" || \
    warn "Service not started (connect scanner to activate)"

echo
echo "Installation complete!"
if [ "$MODE" = "paperless" ]; then
    echo "Scans will be uploaded to Paperless at $PAPERLESS_URL"
else
    echo "Scans will be saved to ~/Documents/scanner-inbox/"
fi
